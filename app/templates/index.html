{% extends 'layout.html' %}

{% block content %}

<main>
    {% if groups or ibans %}
    Wähle
    {% endif %}
    {% if groups %}
    eine Gruppe:
    <ul>
        {% for group in groups %}
        <li><a href="/{{group}}">{{group}}</a></li>
        {% endfor %}
    </ul>
        {% if ibans %}
        oder
        {% endif %}
    {% endif %}
    {% if ibans %}
    ein Konto:
    <ul>
    {% for iban in ibans %}
    <li><a href="/{{iban}}">{{iban}}</a></li>
    {% endfor %}
    </ul>
    {% else %}
    Es sind noch keine Konten vorhanden. Starte mit deinem ersten Import...
    {% endif %}

    <p>
        <button id="add-iban-btn">
        Konten verwalten
        </button>
        <button id="add-group-btn">
        Gruppen verwalten
        </button>
    </p>
    <p>
        <button id="settings-button" title="Settings">⚙️</button>
    </p>
</main>

<!-- PopUps -->
<div id="add-iban" style="display: none;" class="popup">
    <h2>Neue Transaktionen</h2>
    <p>Importiere Kontoumsätze in folgendem Konto:</p>
    <p>
        <input type="text" name="iban-input" id="iban-input" placeholder="DE XXXXXXXXXXXXX" list="iban-list" 
               oninput="this.value = this.value.replace(/\s+/g, '')">
        <datalist id="iban-list">
            {% for iban in ibans %}
            <option value="{{iban}}"></option>
            {% endfor %}
        </datalist>
        <select id="bank-type">
            <option value="Generic">Standardimport</option>
            <option>Comdirect</option>
            <option>Commerzbank</option>
            <option>Volksbank Mittelhessen</option>
        </select>
        <small>
            Nicht ünterstützte Banken können als CSV mit
            <span data-tooltip="Spalten: Buchungstag, Valuta, Art, Buchungstext, Betrag, Währung, Gegenkonto (optional) | Trenner ';'">
                vorgegebenem Format
            </span>
            Über den Standardimport eingelesen werden.
        </small>
    </p>
    <p>
        <div id="file-drop-area">
            <span id="file-label">Datei hier ablegen oder auswählen (PDF / CSV / HTML)</span>
            <input type="file" id="file-input" name="file-input" accept=".csv,.pdf,.html" style="display: none;">
        </div>
    </p>
    <p>
        <button onclick="uploadFile()">Import</button>
        <button onclick="deleteDB()">Löschen</button>
    </p>
    <button onclick="closePopup('add-iban')">Close</button>
</div>


<div id="add-group" style="display: none;" class="popup">
    <h2>Gruppen anlegen</h2>
    <p>Wähle Konten aus, die zu einer Gruppe hinzugefügt werden sollen:</p>
    <ul>
        {% for iban in ibans %}
        <li>
            <label>
                <input type="checkbox" name="iban-checkbox" value="{{iban}}">
                {{iban}}
            </label>
        </li>
        {% endfor %}
    </ul>
    <p>
        <input type="text" name="groupname-input" id="groupname-input" placeholder="" list="group-list">
        <datalist id="group-list">
            {% for group in groups %}
            <option value="{{group}}"></option>
            {% endfor %}
        </datalist>
    </p>
    <p>
        <button onclick="saveGroup()">Speichern</button>
        <button onclick="deleteDB(true)">Löschen</button>
    </p>
    <button onclick="closePopup('add-group')">Close</button>
</div>


<div id="settings-popup" style="display: none;" class="popup">
    <h2>Settings</h2>
    <p>Einstellungen können in die Datenbank importiert werden, ohne sie explizit im Backend ablegen zu müssen:</p>
    <p>
        <select id="settings-type">
            <option value="rule">Regel</option>
            <option value="parser">Parsing-Anweisung</option>
            <option value="config">Einstellungen</option>
        </select>
    </p>
    <p>
        <div id="settings-drop-area">
            <span id="file-label">Datei hier ablegen oder auswählen (PDF / CSV / HTML)</span>
            <input type="file" id="settings-input" name="settings-input" accept=".csv,.pdf,.html" style="display: none;">
        </div>
        <button onclick="importSettings()">Importieren</button>
    </p>

    <p>
        Alternativ können auch Werte für einzelne Einträge abgefragt und direkt geändert werden:
    </p>
    <p>
        <select id="read-setting">
            {% for m in meta %}
            <option value="{{m.uuid}}">{{m.metatype}} "{{m.name}}" ({{m.uuid}})</option>
            {% endfor %}
        </select>
        <textarea id="set-setting" placeholder="Setting Wert" rows="10" cols="15"></textarea>
        <button onclick="loadSetting()">Laden</button>
        <button onclick="saveSetting()">Speichern</button>
    </p>
    
    <button onclick="closePopup('settings-popup')">Close</button>
</div>

<script src="{{ url_for('static', filename='js/index.js') }}"></script>

{% endblock %}
